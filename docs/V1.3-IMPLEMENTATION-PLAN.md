# V1.3 Implementation Plan - Portrait Rendering Fix

**Goal:** Make Pokemon portraits render crisp instead of blurry on high-DPI displays.

**Status:** DEFERRED - Requires more invasive approach than initially planned.

---

## Problem Summary

| Element | Rendering Method | Result |
|---------|------------------|--------|
| Battle sprites | Phaser canvas with `pixelArt: true` | **Crisp** |
| Portraits | DOM `<img>` with CSS `width: 7.5vw` | **Blurry** |

When `7.5vw` resolves to non-integer pixels (e.g., 108.75px on 1450px viewport), the browser interpolates the 40px source sprites, causing blur.

---

## What We Learned (V1.2 Attempts)

### Attempt 1: CSS `image-rendering: pixelated`
- **Result:** No effect
- **Reason:** Upstream already applies this to portraits

### Attempt 2: Fixed pixel sizes via CSS
- **Result:** Broke layout
- **Reason:** Game expects responsive sizing; fixed sizes created misalignment

### Attempt 3: JavaScript snap to integer multiples
- **Result:** Partial success, but too broad
- **Reason:** Affected elements beyond portraits; couldn't reliably target only blurry elements

### Key Insight
The blur is inherent to viewport-relative units (`vw`, `vh`, `%`) when they resolve to fractional pixels. The only true fix is forcing integer pixel sizes, but this conflicts with the game's responsive layout.

---

## Proposed Solution: Resolution-Aware CSS Overrides

### Concept
Instead of fighting the responsive layout, embrace it with **media query breakpoints** that snap to clean integer multiples of the 40px base sprite size at common resolutions.

### Implementation Strategy

#### Phase 1: Research & Mapping
1. Document all portrait containers and their CSS selectors
2. Map viewport widths to current computed portrait sizes
3. Identify the "snap points" where 7.5vw equals clean multiples of 40px

```
Viewport Width -> 7.5vw -> Nearest 40px multiple
1024px         -> 76.8px  -> 80px (2x)
1280px         -> 96px    -> 80px or 120px (2x or 3x)
1440px         -> 108px   -> 120px (3x)
1920px         -> 144px   -> 160px (4x)
2560px         -> 192px   -> 200px (5x)
```

#### Phase 2: CSS Injection
Create resolution-specific overrides:

```css
/* Portrait crisp rendering - resolution-aware snap */

/* Base: ensure pixelated rendering */
.game-pokemon-portrait img,
.game-pokemons-store .game-pokemon-portrait img {
    image-rendering: pixelated !important;
    image-rendering: crisp-edges !important;
}

/* 1024px - 1279px: Snap to 80px (2x base) */
@media (min-width: 1024px) and (max-width: 1279px) {
    .game-pokemons-store .game-pokemon-portrait {
        width: 80px !important;
        height: 80px !important;
    }
    .game-pokemons-store .game-pokemon-portrait img {
        width: 75px !important;
        height: 75px !important;
    }
}

/* 1280px - 1439px: Snap to 80px or 120px */
@media (min-width: 1280px) and (max-width: 1439px) {
    .game-pokemons-store .game-pokemon-portrait {
        width: 80px !important;
        height: 80px !important;
    }
}

/* 1440px - 1919px: Snap to 120px (3x base) */
@media (min-width: 1440px) and (max-width: 1919px) {
    .game-pokemons-store .game-pokemon-portrait {
        width: 120px !important;
        height: 120px !important;
    }
}

/* 1920px - 2559px: Snap to 160px (4x base) */
@media (min-width: 1920px) and (max-width: 2559px) {
    .game-pokemons-store .game-pokemon-portrait {
        width: 160px !important;
        height: 160px !important;
    }
}

/* 2560px+: Snap to 200px (5x base) */
@media (min-width: 2560px) {
    .game-pokemons-store .game-pokemon-portrait {
        width: 200px !important;
        height: 200px !important;
    }
}
```

#### Phase 3: Layout Compensation
The shop container uses flexbox with gaps. Changing portrait sizes will affect:
- Gap spacing between portraits
- Total row width
- Overflow behavior

May need additional CSS to adjust:
```css
.game-pokemons-store {
    justify-content: center !important;
    gap: [calculated]px !important;
}
```

#### Phase 4: Testing Matrix
Test at each breakpoint on:
- 1080p (1920x1080)
- 1440p (2560x1440)
- 4K (3840x2160)
- Ultrawide (3440x1440)
- Laptop (1366x768)

Verify:
- [ ] Portraits are crisp (no subpixel blur)
- [ ] Shop layout is not broken
- [ ] Portraits don't overflow container
- [ ] Hover states work correctly
- [ ] Additional picks popup unaffected

---

## Alternative Approaches

### Option B: Canvas-Based Portrait Rendering
Replace DOM `<img>` portraits with canvas elements that use nearest-neighbor scaling.

**Pros:**
- Perfect pixel control
- Works at any resolution

**Cons:**
- Significant implementation effort
- May conflict with upstream updates
- Performance overhead

### Option C: SVG Wrapper with `shape-rendering: crispEdges`
Wrap portraits in SVG with explicit pixel dimensions.

**Pros:**
- Resolution-independent
- Native browser support

**Cons:**
- Complex DOM structure
- May break hover/click handlers

### Option D: Accept the Blur
Document that this is an upstream limitation and close the issue.

**Pros:**
- Zero maintenance burden
- No risk of breaking layout

**Cons:**
- Doesn't solve the user's visual quality concern

---

## Files to Modify

- `src-tauri/src/main.rs` - Add CSS to perfStyles section in OVERLAY_SCRIPT

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Layout breaks at edge resolutions | Medium | High | Extensive breakpoint testing |
| Upstream CSS changes break overrides | Low | Medium | Use specific selectors, re-test on upstream updates |
| Performance impact from CSS recalc | Low | Low | CSS-only, no JS overhead |
| User confusion if portraits "jump" sizes | Low | Low | Snap points are close to natural sizes |

---

## Success Criteria

1. Shop portraits render without subpixel blur at 1080p, 1440p, 4K
2. Shop layout maintains proper spacing and alignment
3. No visual "jump" when resizing window across breakpoints
4. Additional picks popup remains unaffected
5. No performance regression

---

## Estimated Effort

- Research & selector mapping: 1-2 hours
- CSS implementation: 1 hour
- Testing across resolutions: 2-3 hours
- Layout fixes (if needed): 1-2 hours

**Total: 5-8 hours**

---

## Decision

**Recommendation:** Defer to V1.4 or later. The current blur is subtle and the fix carries layout risk. Prioritize stability over visual polish for now.

**Revisit when:**
- Users explicitly request crisp portraits
- Upstream changes their portrait sizing approach
- We have a test matrix for multiple resolutions
